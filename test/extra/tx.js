/**
 * tx.js
 *
 * Tests for lib/extra/tx.js
 */

const { describe, it } = require('mocha')
const { expect } = require('chai')
const Run = require('../env/run')
const bsv = require('bsv')
const { Tx } = Run.extra

// ------------------------------------------------------------------------------------------------
// Tx
// ------------------------------------------------------------------------------------------------

describe('Tx', () => {
  it('parse transaction', async () => {
    const rawtx = '010000000152be1adbf94555019711aef6b00795516852a06c5f5afe2b03ffd9b14dfa053d010000006b483045022100deafb89e740bb70d6c28e2d722f680ecdd7036ae29b0f3fac13108421d9bdfaf02205e2d93da4bc7942986c3c7501466844c98949dd1367c8088bbc780abb79999fe4121039c35c5f7452059e4fb9fd02f317635cba01d7d5adfa55048a507129155884c91ffffffff030000000000000000fdcc01006a2231394878696756345179427633744870515663554551797131707a5a56646f4175743843616d6520666f72207468652065646779206d61726b6574696e672c2073746179656420666f722074727574682026206b696e646e6573730a746578742f706c61696e04746578741f7477657463685f7477746578745f313538313133373730353033392e747874017c223150755161374b36324d694b43747373534c4b79316b683536575755374d74555235035345540b7477646174615f6a736f6e046e756c6c0375726c046e756c6c07636f6d6d656e74046e756c6c076d625f757365720432333530047479706504706f73740974696d657374616d701131323234363635363235393932343435340361707006747765746368017c22313550636948473232534e4c514a584d6f53556157566937575371633768436676610d424954434f494e5f454344534122314a4c4275744d5a5055377875325055425078656b5463704a4b507a5a756154755a4c584945616d6b7772394865727332774f6c46553246307a50316f68654e38685a583047796666704c517541673952594b3359384c3152586f7455736b4f6733776965343265436b5558326e69725739782f336b38455231773d4d180000000000001976a91405186ff0710ed004229e644c0653b2985c648a2388accd1f0000000000001976a9140710fe5e246c1f1b2e31aa10bbc6ff041a1e1e8088ac00000000'
    const tx = new Tx(rawtx)
    expect(tx.version).to.equal(1)
    expect(tx.inputs.length).to.equal(1)
    expect(tx.inputs[0].prevTxId).to.equal('3d05fa4db1d9ff032bfe5a5f6ca05268519507b0f6ae1197015545f9db1abe52')
    expect(tx.inputs[0].outputIndex).to.equal(1)
    expect(tx.inputs[0].script).to.equal('483045022100deafb89e740bb70d6c28e2d722f680ecdd7036ae29b0f3fac13108421d9bdfaf02205e2d93da4bc7942986c3c7501466844c98949dd1367c8088bbc780abb79999fe4121039c35c5f7452059e4fb9fd02f317635cba01d7d5adfa55048a507129155884c91')
    expect(tx.inputs[0].sequenceNumber).to.equal(4294967295)
    expect(tx.outputs.length).to.equal(3)
    expect(tx.outputs[0].satoshis).to.equal(0)
    expect(tx.outputs[0].script).to.equal('006a2231394878696756345179427633744870515663554551797131707a5a56646f4175743843616d6520666f72207468652065646779206d61726b6574696e672c2073746179656420666f722074727574682026206b696e646e6573730a746578742f706c61696e04746578741f7477657463685f7477746578745f313538313133373730353033392e747874017c223150755161374b36324d694b43747373534c4b79316b683536575755374d74555235035345540b7477646174615f6a736f6e046e756c6c0375726c046e756c6c07636f6d6d656e74046e756c6c076d625f757365720432333530047479706504706f73740974696d657374616d701131323234363635363235393932343435340361707006747765746368017c22313550636948473232534e4c514a584d6f53556157566937575371633768436676610d424954434f494e5f454344534122314a4c4275744d5a5055377875325055425078656b5463704a4b507a5a756154755a4c584945616d6b7772394865727332774f6c46553246307a50316f68654e38685a583047796666704c517541673952594b3359384c3152586f7455736b4f6733776965343265436b5558326e69725739782f336b38455231773d')
    expect(tx.outputs[1].satoshis).to.equal(6221)
    expect(tx.outputs[1].script).to.equal('76a91405186ff0710ed004229e644c0653b2985c648a2388ac')
    expect(tx.outputs[2].satoshis).to.equal(8141)
    expect(tx.outputs[2].script).to.equal('76a9140710fe5e246c1f1b2e31aa10bbc6ff041a1e1e8088ac')
    expect(tx.nLockTime).to.equal(0)
  })

  // --------------------------------------------------------------------------

  it('parses OP_PUSHDATA2', () => {
    const bsvtx = new bsv.Transaction()
    const data = Buffer.from(new Array(100000).fill(1)).toString('hex')
    const script = bsv.Script.fromASM(`${data}`)
    bsvtx.addOutput(new bsv.Transaction.Output({ script, satoshis: 10000 }))
    const rawtx = bsvtx.toString('hex')
    const tx = new Tx(rawtx)
    expect(tx.outputs[0].script).to.equal(script.toHex())
  })
})

// ------------------------------------------------------------------------------------------------
